---
title: 存储器层次结构
categories:
  - []
tags:
  - null
date: 2020-05-29 19:33:03
---

<!--more-->
简单计算机系统模型：CPU执行指令，存储系统存放指令和数据；
- 在简单模型当中，存储器是一个线性字节数组，CPU能在一个常数时间内访问每个存储器位置；
- 虽然其是一个有效的模型，但是它没有反映现代系统实际工作的方式；

实际上，存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构。

## 1 存储技术
### 1.1 随机访问存储器
**1、随机访问存储器**
重点：随机访问存储器（Random-Access Memory, RAM），静态随机访问存储器（SRAM），动态随机访问存储器（DRAM）。

随机访问存储器分为两类：静态随机访问存储器和动态随机访问存储器。
- SRAM比DRAM更快，但也贵得多；
- SRAM用来作为高速缓存存储器，既可以在CPU芯片上，也可以在片下；典型的，一个桌面系统的SRAM不会超过几兆字节；
- DRAM用来作为主存以及图形系统的帧缓冲区，通常有几百或几千兆字节；

SRAM将每个位存储在一个双稳态存储器单元里，每个单元是用一个六晶体管电路来实现的。

DRAM将每个位存储为一个电容的充电。
{% asset_img 1.png %}

**2、传统的DRAM**
重点:DRAM芯片，DRAM单元，超单元（supercell），超单元地址，引脚（pin），内存控制器（memory controller），行访问选通脉冲（row access strobe，RAS，列访问选通脉冲（col access strobe，CAS），内部行缓冲区

DRAM芯片中的 **单元**（位）被分成 $d$ 个 **超单元**（supercell），每个超单元都由 $w$ 个DRAM单元组成。一个 $d \times w$ 的DRAM总共存储了 $dw$ 位信息。
- 超单元被组织成一个 $r$ 行 $c$ 列的长方形阵列（$rc = d$）,每个超单元有形如 $(i, j)$ 的地址， $i$ 表示行， $j$ 表示列；
- 信息通过称为引脚的外部连接器流入和流出芯片，每个引脚携带1位的信号（下图给出了两组引脚：8个data的引脚，它们能传送一个字节到芯片或从芯片传出一个字节；2个addr引脚，它们携带2位的行和列超单元地址，其它控制信息的引脚没有显示出来）；

每个DRAM芯片被连接到某个称为内存控制器的电路，这个电路可以一次传送 $w$ 位到每个DRAM芯片或一次从每个DRAM芯片传出 $w$ 位。
- 为了读出超单元 $(i, j)$ 的内容，内存控制器将行地址 $i$ 发送到DRAM，然后是列地址 $j$；DRAM把超单元$(i, j)$ 的内容发回给控制器作为响应；行地址 $i$ 称为RAS请求，列地址 $j$ 称为 CAS请求；RAS和CAS请求共享相同的DRAM地址引脚。

{% asset_img 2.png %}

例如，要从下图中 $16 \times 8$ 的DRAM中读出超单元 $(2, 1)$
- 内存控制器发送行地址 $2$;
- DRAM的相应将 $2$ 的整行内容都复制到一个内部行缓冲区域；
- 接下来，内存控制器发送列地址 $1$；
- DRAM的相应从行缓冲区复制出超单元 $(2, 1)$ 中的8位，并把它们发送到内存控制器；

{% asset_img 3.png %}

注意：
- 电路设计者将DRAM组织成二维阵列而不是线性数组的一个原因是降低芯片萨和嗯地址引脚的数量；
- 二维阵列组织的缺点是，必须分两步发送地址，这增加了访问的时间；

**3、内存模块**
重点：内存模块（memory module）

DRAM芯片封装在内存模块中，它插到主板的扩展槽上。
- Core i7系统使用240个引脚的双列内存模块（Dual Inline Memory Module， DIMM），它以64位为块传送数据到内存控制器和从内存控制器传出数据。

下图展示了一个内存模块的基本思想。
- 示例模块用了8个8M x 8的DRAM芯片，总共存储64M，这8个芯片编号为0-7；
- 每个超单元存储主存的一个字节，而用相应超单元地址为(i, j)的8个超单元来表示主存中字节地址A处的64位字：DRAM0存储第一个（低位）字节，DRAM1存储下一个字节，依次类推。

{% asset_img 4.png %}

要取出内存地址A处的一个字，
- 内存控制器将A转化为超单元地址(i, j)，并将其发送到内存模块；
- 内存模块将 i 和 j 广播到每个 DRAM；
- 作为响应，每个DRAM输出它的(i, j)超单元的8位内容；
- 模块中的电路收集这些输出，并将他们合并成一个64位字，再返回i给内存控制器；

通过将多个内存模块连接到内存控制器，能够聚合成主存。
- 当控制器收到一个地址A时，控制器选择包含A的模块k，将A转换成它的(i, j)的形式，并将(i, j)发送到模块k；

**4、增强的DRAM**
有很多种DRAM存储器，它们都是基于传统DRAM单元进行了一些优化，提高访问基本DRAM单元的速度。
- 快页模式DRAM（fast page mode DRAM, FPM DRAM）;
- 扩展数据输出DRAM（extended data out DRAM, EDO DRAM）;
- 同步DRAM（synchronous DRAM, SDRAM）;
- 双倍速率同步DRAM（double data-rate synchronous DRAM, DDR SDRAM）;
- 视频RAM（vedio RAM, VRAM）;

DRAM技术流行史：
- 直到1995年，大多数PC都是用FPM DRAM；
- 1996-1999，EDO DRAM在市场上占据了主导，而FPM DRAM几乎销声匿迹了；
- SDRAM最早出现在1995年的高端系统中，到2002年，大多数PC都是用SDRAM和DDR SDRAM；
- 到2010年之前，大多数服务器和桌面系统都是用DDR3 SDRAM构造的，实际上，Intel Core i7只支持DDR3 SDRAM；

### 1.2 非易失性存储器
重点：易失性（volatile）存储器，非易失性存储器（nonvolatile memory），只读存储器（Read-Only Memory，RAM）

如果断电，DRAM和SRAM会丢失它们的信息，它们是易失性存储器。非易失性存储器，即使在断电后，仍然保存着它们的信息。由于历史原因，虽然ROM中有的类型既可以读也可以写，但是它们整体上被称为只读存储器。ROM是以它们能够被重编程的次数和对它们进行重编程所用的机制来区分的。
- 可编程ROM（Programmable ROM）：只能被编程一次，每个存储器单元有一种熔丝，只能用高电流熔断一次；
- 可擦写可编程ROM（Erasable Programmable ROM，EPROM）：有一个透明的石英窗口，允许光到达存储单元，紫外线光照射过窗口，EPROM单元就被清除为0，对EPROM编程是通过使用一种把1写入EPROM的特殊设备来完成的。EPROM能够被擦出和重编程的此书的数量级可以达到1000次；
- 电子可擦除PROM（Electrically Erasable PROM，EEPROM）：类似于EPROM，但不需要一个物理上独立的编程设备，可直接在印制电路卡上编程，其能够被编程的次数的数量级可达到100000次；
- 闪存（Flash Memory）：一类非易失性存储器，基于EEPROM，已经成为了一种重要的存储技术。固态硬盘（Solid State Disk，SSD）是一种新型，基于闪存的磁盘驱动器，相比传统旋转磁盘，其具有更快速，更强健，更低能耗等优点；

存储在ROM设备中的程序通常被称为固件（firmware）。

### 1.3 磁盘

**1、磁盘构造**
重点：磁盘（disk），盘片（platter），表面（surface），主轴（spindle），磁道（track），扇区（sector），间隙（gap），柱面（cylinder）

磁盘是广为应用的保存大量数据的存储设备，存储数据的数量级可达到几百到几千千兆字节，但从其上读取信息的时间位毫秒级，比DRAM慢了10万倍，比SRAM读慢了100万倍。其构造如下图所是：

{% asset_img 5.png %}

**2、磁盘容量**
重点：记录密度（recording density，位/英寸），磁道密度（track density， 道/英寸），面密度（areal density，位/平方英寸）。

一个磁盘上可以记录的最大位数称为它的容量，其由以下技术因素决定：
- 记录密度：磁道一英寸的段中可以放入的位数；
- 磁道密度：从盘片中心处罚半径上一英寸的段内可以有的磁道数；
- 面密度：记录密度与磁道密度的乘积；

磁盘制造商不懈的努力以提高面密度，从而增加容量，通常面密度每隔几年就会翻倍。计算磁盘容量公式如下：
$$磁盘容量 = \frac{字节数}{扇区} \times\frac{平均扇区数}{磁道} \times \frac{磁道数}{裱边} \times\frac{表面数}{盘片} \times\frac{盘片数}{磁盘}$$

**3、磁盘操作**
重点：读/写头（read/write head），传动臂（actuator arm），寻道（seek），访问时间（access time）。

磁盘用读/写头来读写存储在磁性表面的位，其原理如下图所示。
- 有多个盘片的磁盘针对每个盘面都有一个独立的读/写头；
- 读/写头垂直排列，一致行动，任何时刻，所有的读/写头都位于同一柱面上；
- 为了避免读/写头冲撞（head crash），磁盘总是密封包装的；

{% asset_img 6.png%}

磁盘以扇区大小的块来读写数据。对于扇区的访问时间有三个主要部分：寻道时间（seek time），旋转时间（rotational time），传送时间（transfer time）。
- 寻道时间：为了读取某个目标扇区的内容，传动臂首先将读/写头定位到包含目标扇区的磁道上，移动传动臂所需的时间称为寻道时间。现代驱动器中平均寻道时间是通过几千次对随机扇区的寻道平均值来测量的，通常为3-9ms，一次寻道的最大时间可高达20ms；
- 旋转时间：一旦读/写头定位到了期望的磁道，驱动器等待目标扇区的第一个位旋转到读/写头下。最大旋转时间为：
$$T_{max rotation} = \frac{1}{RPM} \times 60$$
- 传送时间：当目标扇区的第一个位位于读/写头下时，驱动器就可以开始读或者写该扇区的内容了。一个扇区的平均传送时间如下：
$$T_{avg transfer} = \frac{60}{RPM} \times \frac{1}{平均扇区数/磁道}$$

示例，某一磁盘参数如下：
- 旋转速率：7200rpm；
- 平均寻道时间：9ms；
- 每条磁道的平均扇区数：400；

平均旋转时间：4s；平均传送时间0.02s。
- 访问一个磁盘扇区中512字节的时间主要是寻道时间和旋转时间，传送时间与之相比几乎不用时间；
- 对于存储在SRAM中的一个64位字的访问时间大约是4ns，对DRAM的访问时间是60ns；因此，从内存中读一个512字节扇区大小的块的时间对SRAM来说大约是256ns，对DRAM来说大约是4000ns；磁盘访问时间，大约10ms，是