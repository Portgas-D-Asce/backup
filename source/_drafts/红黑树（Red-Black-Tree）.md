---
title: 红黑树（Red Black Tree）
author: Portgas·D·Asce
categories:
  - [Data Structure & Algorithm]
tags:
  - 基础数据结构
  - 二叉树
  - 二叉搜索树
date: 2020-12-22 16:43:56
---

红黑树，初中级别，小学生不宜观看！！！

<!--more-->

本文内容主要是用来加深对红黑树的理解，没有了解过红黑树 和 AVL 树不建议阅读！！！

## 1 红黑树认知
### 1.1 性质

红黑树，是一种平衡二叉搜索树，它满足以下 5 条性质：
- 性质 1 : 所有节点，非黑即红；
- 性质 2 : 根节点为黑色；
- 性质 3 : 所有叶节点（NIL）都为黑；
- 性质 4 : 红色节点的两个子结点都是黑色；
- 性质 5 : 对于每个节点，从该节点到叶节点的简单路径上，黑色节点数目相同；

### 1.2 如何保证平衡
同 AVL 树是一样的，本质上还是通过树高来控制平衡的：
- 这一点正是，红黑树的失衡调整与 AVL 树的失衡调整十分相似的原因（实际上，红黑树的失衡调整可以看作是 AVL 树失衡调整的进阶版）；

红黑树中最长路径不会超过最短路径的 2 倍；
- 为什么不超过 2 倍？
  - 最长路径和最短路径上黑色节点个数相同（性质 5）；
  - 路径上黑色节点个数一定大于红色节点个数（性质 4）；
- 一棵有 n 个内部节点的（<!--------------->）

## 2 插入

以下内容对于理解红黑树插入操作很重要，目前不理解没关系，但一定要结合后续内容好好理解：
- 插入操作如果导致冲突，那么冲突一定是 **双红冲突** （孙子节点为红色，父节点也为红色，俗称父子矛盾）；
- 插入操作的核心就是如何解决双红冲突（姑且称之为 **插入调整**）；
- 插入调整策略：站在 **爷爷节点** 往下看；


### 2.1 插入的节点是红色

为什么插入节点是红色的？黑色的不行吗？
- 如果是黑色的，插入新节点 **一定** 会产生冲突（违反性质 5）；
- 如果是红色，**可能** 会产生冲突（双红，违反性质 4）；
- 显然，插入红色节点更好。

### 2.2 情况一

叔叔节点为红色：

{% asset_img 1.png %}

解决办法：
- 叔节点和父节点改成黑色（解决双红冲突）；
- 爷爷节点改成红色（保证黑高不变）；
- 但爷爷节点和它的父节点可能产生新的冲突，需要不断地处理，直到没有冲突为止；

调整后结果：

{% asset_img 2.png %}

### 2.3 情况二

叔节点为黑色（下图为 LL 型）：

{% asset_img 3.png %}

解决办法：
- 高度差调整：同 AVL 树 LL 型调整（即抓着爷爷节点 “大右旋”）
- 颜色调整：将父节点调整为黑色（解决双红冲突），将爷爷节点调整为红色（保证黑高不变）；

调整后结果：

{% asset_img 4.png %}

其它类似情况还有：
- RR 型：
  - 高度差调整：同 AVL 树 RR 型调整（即抓着爷爷节点 “大左旋”）；
  - 颜色调整：同 LL 型；
- LR 型：通过 “小左旋”，先将其转化为 LL 型，然后再进行处理（仅对小左旋部分如何处理进行说明，转化为 LL 型后该如何处理不再赘述）；
  - 高度差调整（小左旋）：同 AVL 树 LR 型的小左旋；
  - 颜色调整（小左旋）：??????????????????????
- RL 型：通过 “小右旋”，将其转化为 RR 型，再进行处理（仅对小右旋部分如何处理进行说明，转化为 RR 型后该如何处理不再赘述）；
  - 高度差调整（小右旋）：同 AVL 树 RL 型的小左旋；
  - 颜色调整（小右旋）：??????????????????????
<!--无论是情况一还是情况二，最终结果都出奇的一致：爷爷和孙子戴红帽子，父亲和叔叔戴黑帽子（果然隔代亲）-->

## 3 删除
以下内容对于理解红黑树删除操作很重要，目前不理解没关系，但一定要结合后续内容好好理解：
- 删除操作产生的冲突一定是 “双重黑” 冲突；
- 删除操作的核心就是如何解决 “双重黑” 冲突（**删除调整**）；
- 删除调整策略：站在 **父节点** 看。

### 3.1 什么时候删除调整
当删除点度为 2 时：用其前缀取代它，将问题转化为删除度为 0 或 1 的节点；所以删除节点实际上只有两种情况：
- 删除度为 0 的节点;
- 删除度为 1 的节点；

何时需要进行删除调整：
- 当删除点是红色时：
  - 度为 0（无需删除调整）：删除即可；
  - 度为 1（无需删除调整）：独生子取代父亲即可；
- 当删除节点是黑色时：
  - 度为 0 时（需要删除调整）：删除后，产生了一个双重黑的 NIL （违反性质 5）；
  - 度为 1 时（无需删除调整）：它的独生子一定为红色（如果不为红色，就违反性质 5 了）；独生子取代父亲，并把独生子染成黑色；

**结论：只有删除黑色节点且导致双层黑的时候，才需要删除调整。**

### 3.2 情况一
双重黑的兄弟是黑色，且兄弟的两个儿子也是黑色：
{% asset_img 5.png %}

解决办法：
- 子节点把多的一层黑给父节点；
  - 如果父节点本身为黑，则父节点变成双重黑，问题没解决（矛盾转移了）；
  - 如果父节点本身为红，则父节点染成黑色，问题解决
- 兄弟节点染成红色（父节点多了一层黑）；

子结点双重黑传递给父节点后：
{% asset_img 6.png %}

### 3.3 情况二
双重黑的兄弟节点为黑色，右兄弟的右儿子（或左兄弟的左儿子）为红色（RR 型）：
{% asset_img 7.png %}

解决办法：
- 对以父节点为根的子树进行 “大左旋”；
- 把右兄弟节点的颜色染成符父节点的颜色；
- 把右兄弟的右儿子染成黑色；

干掉双重黑后：
{% asset_img 8.png %}

疑问：大左旋之后，双重黑冲突已经处理掉了，为什么还需要染色？大左旋结果：

{% asset_img 9.png %}

答：当48号节点为红色，42号节点为黑色时也是没问题的，但大左旋之后，48号和38号构成了 “双红冲突”，所以需要染色处理一下；

其它类似情况：
- LL 型：左兄弟为黑色，左兄弟的左孩子为红色；类似于 RR 型，只不过是 “大右旋”；
- RL 型：右兄弟为黑色，右兄弟的左孩子为红色；先对 以右兄弟为根的子树 进行 “小右旋”，染色，转化成 RR 型；
- LR 型：左兄弟为黑色，左兄弟的右孩子为红色；先对 以左兄弟为根的子树 进行 “小左旋”，染色，转化成 LL 型；
- **注意：** LL 型的优先级高于 LR 型；RR 型的优先级高于 RL 型；

<!--对于AVL树，LR情况可以直接转换成LL类型，RL可以之间转换成RR类型，对于红黑树，也类似，但它需要加额外的染色，才能完成真正的转变-->
### 3.4 情况三
当右兄弟节点为红色时；

解决办法：
- 将 以父节点为根的子树 进行左旋；
- 将右兄弟染成黑色，右兄弟的左孩子染成红色；
- 可能引入 “叔节点为黑色的双红问题“；

类似情况：
- 当左兄弟节点为红色时：左旋，左兄弟染黑，左兄弟的右孩子染成红色；







## 4 小结

无论是删除还是插入，对于不同情况该如何处理需要简单记忆，而且要搞明白，为什么那么处理就能够解决冲突（一定要多问自己几遍，每一种情况都要问）；

红黑树调整 与 AVL 树调整：
- AVL 树调整：只进行 大旋，小旋操作；
- 红黑树调整：每次进行完 大旋，小旋后，需要进行一次颜色调整；

## 扩展


红黑树讲的原来是父与子的故事：
- **插入：** 一天，父亲戴了红帽子，儿子也戴了红帽子，父亲觉得儿子不该戴红帽子，儿子觉得父亲不应该戴红帽子，于是他们请了爷爷来评理，还请了叔叔来观看；
- **删除：** 又一天，父亲发现自己儿子特别黑，然后略带悲伤地对儿子说，我带你去做亲子鉴定吧...


